# 适配ShadowSocks+v2ray-plugin的HAProxy配置
# /etc/haproxy/haproxy.cfg
# 已添加wascell.com支持

global
    daemon
    user haproxy
    group haproxy
    log stdout local0

    # SSL优化配置
    ssl-default-bind-ciphers ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!SHA1:!AESCCM
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode tcp
    log global
    option tcplog
    timeout connect 10s
    timeout client 1m
    timeout server 1m

# 443端口SNI分流入口
frontend https_router
    bind *:443
    mode tcp

    # TCP层检查SSL握手包
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # 根据SNI域名分流
    acl is_lawsker req_ssl_sni -i lawsker.com
    acl is_lawsker_www req_ssl_sni -i www.lawsker.com
    acl is_etemple req_ssl_sni -i etemple.live
    acl is_etemple_www req_ssl_sni -i www.etemple.live
    acl is_wascell req_ssl_sni -i wascell.com
    acl is_wascell_www req_ssl_sni -i www.wascell.com

    # 检测是否为Cloudflare伪装流量（VPN流量会伪装为www.cloudflare.com）
    acl is_cloudflare_fake req_ssl_sni -i www.cloudflare.com
    acl is_cloudflare_fake req_ssl_sni -i cloudflare.com

    # 分流规则
    use_backend lawsker_nginx if is_lawsker
    use_backend lawsker_nginx if is_lawsker_www
    use_backend etemple_nginx if is_etemple
    use_backend etemple_nginx if is_etemple_www
    use_backend wascell_nginx if is_wascell
    use_backend wascell_nginx if is_wascell_www

    # 所有其他流量（包括伪装为Cloudflare的VPN流量）转发到VPN
    default_backend shadowsocks_vpn

# Lawsker应用后端
backend lawsker_nginx
    mode tcp
    balance roundrobin
    server nginx 127.0.0.1:8444 check

# Etemple应用后端
backend etemple_nginx
    mode tcp
    balance roundrobin
    server nginx 127.0.0.1:8445 check

# Wascell应用后端
backend wascell_nginx
    mode tcp
    balance roundrobin
    server nginx 127.0.0.1:8446 check

# ShadowSocks VPN后端
backend shadowsocks_vpn
    mode tcp
    balance roundrobin
    server shadowsocks 127.0.0.1:8443 check

# HTTP重定向到HTTPS
frontend http_redirect
    bind *:80
    mode http

    # 域名重定向到HTTPS
    acl is_lawsker_http hdr(host) -i lawsker.com
    acl is_lawsker_www_http hdr(host) -i www.lawsker.com
    acl is_etemple_http hdr(host) -i etemple.live
    acl is_etemple_www_http hdr(host) -i www.etemple.live
    acl is_wascell_http hdr(host) -i wascell.com
    acl is_wascell_www_http hdr(host) -i www.wascell.com

    redirect scheme https code 301 if is_lawsker_http
    redirect scheme https code 301 if is_lawsker_www_http
    redirect scheme https code 301 if is_etemple_http
    redirect scheme https code 301 if is_etemple_www_http
    redirect scheme https code 301 if is_wascell_http
    redirect scheme https code 301 if is_wascell_www_http

    # 其他域名的HTTP请求保持现有Nginx处理
    default_backend current_nginx

# 现有Nginx后端（用于80端口的其他应用）
backend current_nginx
    mode http
    balance roundrobin
    server nginx 127.0.0.1:8080 check

# HAProxy统计页面
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
